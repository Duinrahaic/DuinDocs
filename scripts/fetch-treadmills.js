const fs = require('fs');
const path = require('path');
const https = require('https');

const TREADMILL_DATA_URL = 'https://raw.githubusercontent.com/Duinrahaic/treadmill-compatibility/master/data/treadmills.json';
const JSON_OUTPUT_PATH = path.join(__dirname, '../public/data/treadmills.json');
const TS_OUTPUT_PATH = path.join(__dirname, '../src/data/treadmills.ts');

function fetchTreadmillData() {
  return new Promise((resolve, reject) => {
    https.get(TREADMILL_DATA_URL, (res) => {
      let data = '';

      res.on('data', (chunk) => {
        data += chunk;
      });

      res.on('end', () => {
        try {
          const json = JSON.parse(data);
          resolve(json);
        } catch (error) {
          reject(new Error(`Failed to parse JSON: ${error.message}`));
        }
      });
    }).on('error', (error) => {
      reject(new Error(`Failed to fetch data: ${error.message}`));
    });
  });
}

async function main() {
  try {
    console.log('Fetching treadmill data from GitHub...');
    const data = await fetchTreadmillData();

    // Ensure directories exist
    const jsonDir = path.dirname(JSON_OUTPUT_PATH);
    if (!fs.existsSync(jsonDir)) {
      fs.mkdirSync(jsonDir, { recursive: true });
    }

    const tsDir = path.dirname(TS_OUTPUT_PATH);
    if (!fs.existsSync(tsDir)) {
      fs.mkdirSync(tsDir, { recursive: true });
    }

    // Write JSON file
    fs.writeFileSync(JSON_OUTPUT_PATH, JSON.stringify(data, null, 2));

    // Write TypeScript file
    const tsContent = `// This file is auto-generated by scripts/fetch-treadmills.js
// Do not edit manually - changes will be overwritten
// Last updated: ${new Date().toISOString()}

export const treadmillData = ${JSON.stringify(data, null, 2)};
`;
    fs.writeFileSync(TS_OUTPUT_PATH, tsContent);

    console.log('✓ Successfully saved treadmill data');
    console.log(`  - JSON: ${JSON_OUTPUT_PATH}`);
    console.log(`  - TypeScript: ${TS_OUTPUT_PATH}`);
    console.log(`  - ${data.treadmills.length} treadmills`);
    console.log(`  - Generated at: ${data.meta.generatedAt}`);
    console.log(`  - Schema version: ${data.meta.schemaVersion}`);
  } catch (error) {
    console.error('✗ Error:', error.message);
    process.exit(1);
  }
}

main();
